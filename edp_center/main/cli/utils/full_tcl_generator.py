#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
full.tcl æ–‡ä»¶ç”Ÿæˆå™¨
è´Ÿè´£åˆå¹¶å¤šä¸ª YAML é…ç½®æ–‡ä»¶å¹¶ç”Ÿæˆ full.tcl æ–‡ä»¶
"""

import sys
import yaml
import shutil
from pathlib import Path
from typing import Optional, Dict, Tuple
from tkinter import Tcl
from datetime import datetime
import logging

from edp_center.packages.edp_common import ValidationError, log_exception, EDPFileNotFoundError
from edp_center.packages.edp_common.error_handler import handle_error, error_context
from edp_center.packages.edp_common.exceptions import ConfigError

# è·å– logger
logger = logging.getLogger(__name__)

from .tcl_generator import build_config_file_paths
from .tcl_generator.path_builder import build_output_path
from .tcl_generator.tcl_file_processor import process_tcl_file
from .tcl_generator.yaml_file_processor import process_yaml_file
from .tcl_generator.variable_writer import write_file_variables
from .tcl_generator.type_info_writer import write_type_info
from .tcl_generator.variable_protection import generate_variable_protection_code
from .tcl_generator.variable_validator import validate_file_variables_are_arrays, validate_all_variables_are_arrays
from .tcl_generator.auto_variables import write_auto_variables
from .tcl_generator.constraint_validator import validate_full_tcl_constraints


@handle_error(error_message="ç”Ÿæˆ full.tcl å¤±è´¥", reraise=True)
def generate_full_tcl(edp_center_path: Path, foundry: str, node: str, project: Optional[str],
                      work_path_info: Optional[Dict], flow_name: str, step_name: str, 
                      current_dir: Optional[Path] = None) -> Tuple[Optional[Path], Optional[Path]]:
    """
    ç”Ÿæˆ full.tcl æ–‡ä»¶ï¼Œåˆå¹¶æ‰€æœ‰é…ç½® YAML æ–‡ä»¶
    
    Args:
        edp_center_path: edp_center è·¯å¾„
        foundry: ä»£å·¥å‚åç§°
        node: å·¥è‰ºèŠ‚ç‚¹
        project: é¡¹ç›®åç§°ï¼ˆå¯é€‰ï¼‰
        work_path_info: å·¥ä½œè·¯å¾„ä¿¡æ¯å­—å…¸ï¼ˆå¯é€‰ï¼‰
        flow_name: æµç¨‹åç§°
        step_name: æ­¥éª¤åç§°
        current_dir: å½“å‰ç›®å½•ï¼ˆå¯é€‰ï¼Œç”¨äºæŸ¥æ‰¾ user_config.yamlï¼‰
        
    Returns:
        (full.tcl æ–‡ä»¶è·¯å¾„, å¤‡ä»½æ–‡ä»¶è·¯å¾„) çš„å…ƒç»„
        - full.tcl æ–‡ä»¶è·¯å¾„ï¼šæ–°ç”Ÿæˆçš„ full.tcl è·¯å¾„
        - å¤‡ä»½æ–‡ä»¶è·¯å¾„ï¼šå¦‚æœå­˜åœ¨å¤‡ä»½ï¼Œè¿”å›å¤‡ä»½æ–‡ä»¶è·¯å¾„ï¼›å¦åˆ™è¿”å› None
        å¦‚æœç”Ÿæˆå¤±è´¥åˆ™è¿”å› (None, None)
    """
    # æ„å»ºæ‰€æœ‰ YAML æ–‡ä»¶è·¯å¾„ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
    config_files = build_config_file_paths(
        edp_center_path, foundry, node, project, work_path_info, flow_name, current_dir
    )
    
    if not config_files:
        # æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼ŒæŠ›å‡ºå¼‚å¸¸
        # æ„å»ºè¯¦ç»†çš„è§£å†³å»ºè®®
        suggestion_parts = [
                "è¯·æ£€æŸ¥é…ç½®æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨äºæ­£ç¡®çš„ä½ç½®ï¼š",
                "",
                "é…ç½®æ–‡ä»¶æŸ¥æ‰¾è·¯å¾„ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰ï¼š",
                "1. user_config.yamlï¼ˆå½“å‰ç›®å½•æˆ–å·¥ä½œç›®å½•ï¼‰",
                f"2. {foundry}/{node}/{project or 'common'}/{flow_name}/{step_name}.yaml",
                f"3. {foundry}/{node}/{project or 'common'}/{flow_name}/common.yaml",
                f"4. {foundry}/{node}/{project or 'common'}/common.yaml",
                f"5. {foundry}/{node}/common/common.yaml",
                f"6. {foundry}/common/common.yaml",
                "",
                "æ£€æŸ¥æ­¥éª¤ï¼š",
                f"1. ç¡®è®¤ edp_center è·¯å¾„æ­£ç¡®: {edp_center_path}",
                f"2. ç¡®è®¤ foundry å’Œ node æ­£ç¡®: {foundry}/{node}",
                f"3. ç¡®è®¤é¡¹ç›®è·¯å¾„æ­£ç¡®: {project or 'common'}",
                f"4. ç¡®è®¤æµç¨‹å’Œæ­¥éª¤åç§°æ­£ç¡®: {flow_name}.{step_name}",
                "",
                "å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¯ä»¥ï¼š",
                "1. åˆ›å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶",
                "2. ä½¿ç”¨ 'edp_init' åˆå§‹åŒ–é¡¹ç›®ç»“æ„",
                "3. æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®çš„ä½ç½®"
        ]
        
        raise ConfigError(
            "æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆ full.tcl",
            config_path=str(edp_center_path / "config"),
            context={
                "edp_center_path": str(edp_center_path),
                "foundry": foundry,
                "node": node,
                "project": project,
                "flow_name": flow_name,
                "step_name": step_name,
                "current_dir": str(current_dir) if current_dir else None
            },
            suggestion="\n".join(suggestion_parts)
        )
    
    # æ„å»ºè¾“å‡ºæ–‡ä»¶è·¯å¾„
    full_tcl_path = build_output_path(work_path_info, flow_name, step_name, current_dir)
    
    # åˆ›å»ºä¸€ä¸ªå…±äº«çš„ Tcl interpreterï¼Œç”¨äºç´¯ç§¯æ‰€æœ‰å˜é‡
    shared_interp = Tcl()
    # åªåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ç±»å‹ä¿¡æ¯æ•°ç»„
    shared_interp.eval("array set __configkit_types__ {}")
    
    # æ‰“å¼€è¾“å‡ºæ–‡ä»¶ï¼Œå‡†å¤‡å†™å…¥
    with open(full_tcl_path, 'w', encoding='utf-8') as f:
        # å†™å…¥æ–‡ä»¶å¤´
        f.write("# Generated by configkit\n")
        f.write("# Merged from the following files (in order, later files override earlier ones):\n")
        for config_file in config_files:
            abs_path = Path(config_file).resolve()
            f.write(f"#   - {abs_path}\n")
        f.write("\n")
        
        # é€ä¸ªè¯»å–å’Œè½¬æ¢é…ç½®æ–‡ä»¶ï¼ˆYAML æˆ– Tclï¼‰ï¼Œè½¬æ¢åç«‹å³è¾“å‡º
        for config_file in config_files:
            try:
                config_file_path = Path(config_file)
                abs_path = config_file_path.resolve()
                
                # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©è§£ææ–¹å¼
                if config_file_path.suffix.lower() == '.tcl':
                    # å¤„ç† Tcl æ–‡ä»¶
                    temp_interp = process_tcl_file(config_file_path, shared_interp)
                else:
                    # å¤„ç† YAML æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰
                    temp_interp = process_yaml_file(config_file_path, shared_interp)
                    if temp_interp is None:
                        # æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡
                        continue
                
                # éªŒè¯è¯¥æ–‡ä»¶å®šä¹‰çš„å˜é‡éƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼ˆå¸¦å‘½åç©ºé—´ï¼‰
                # å¦‚æœéªŒè¯å¤±è´¥ï¼Œvalidate_file_variables_are_arrays ä¼šæŠ›å‡º ValidationError
                validate_file_variables_are_arrays(temp_interp, abs_path)
                
                # ç«‹å³è¾“å‡ºè¯¥æ–‡ä»¶å®šä¹‰çš„å˜é‡
                write_file_variables(shared_interp, temp_interp, abs_path, f)
                
            except (yaml.YAMLError, ConfigError, ValidationError):
                # YAML è§£æé”™è¯¯ã€é…ç½®é”™è¯¯å’ŒéªŒè¯é”™è¯¯å·²ç»åœ¨å„è‡ªçš„å¤„ç†å‡½æ•°ä¸­å¤„ç†äº†ï¼Œè¿™é‡Œé‡æ–°æŠ›å‡º
                raise
            except Exception as e:
                # å…¶ä»–é”™è¯¯ï¼ˆå¦‚æ–‡ä»¶è¯»å–å¤±è´¥ï¼‰ï¼Œè¾“å‡ºè­¦å‘Šä½†ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
                # ä½¿ç”¨ error_context ç»Ÿä¸€å¤„ç†ï¼Œä½†ä¸ä¸­æ–­æµç¨‹
                with error_context(error_message=f"å¤„ç†é…ç½®æ–‡ä»¶å¤±è´¥: {abs_path}", log_error=True, reraise=False):
                    raise ConfigError(
                        f"å¤„ç†é…ç½®æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯: {e}",
                        config_file=str(abs_path),
                        suggestion="è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯»"
                    ) from e
                # å¦‚æœåˆ°è¾¾è¿™é‡Œï¼Œè¯´æ˜é”™è¯¯å·²è¢«å¤„ç†ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
                continue
        
        # éªŒè¯æ‰€æœ‰å˜é‡éƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼ˆå¸¦å‘½åç©ºé—´ï¼‰
        # å¦‚æœéªŒè¯å¤±è´¥ï¼Œvalidate_all_variables_are_arrays ä¼šæŠ›å‡º ValidationError
        validate_all_variables_are_arrays(shared_interp)
        
        # é‡æ–°å†™å…¥è‡ªåŠ¨ç”Ÿæˆçš„å˜é‡ï¼ˆç¡®ä¿å®ƒä»¬ä¸è¢«é…ç½®æ–‡ä»¶è¦†ç›–ï¼‰
        # è¿™äº›å˜é‡åº”è¯¥åœ¨æœ€åï¼Œç¡®ä¿å®ƒä»¬çš„å€¼ä¸ä¼šè¢«é…ç½®æ–‡ä»¶è¦†ç›–
        f.write("\n")  # åœ¨è‡ªåŠ¨ç”Ÿæˆçš„å˜é‡ä¹‹å‰æ·»åŠ ç©ºè¡Œï¼Œä¸é…ç½®æ–‡ä»¶å˜é‡åˆ†éš”
        write_auto_variables(
            work_path_info, foundry, node, project,
            flow_name, step_name, full_tcl_path, edp_center_path, f
        )
        
        # ç”Ÿæˆå˜é‡ä¿æŠ¤ä»£ç ï¼ˆå¦‚æœå­˜åœ¨æ–°æ ¼å¼å˜é‡ï¼‰
        generate_variable_protection_code(shared_interp, f)
        
        # å¯¼å‡ºç±»å‹ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        write_type_info(shared_interp, f)
    
    # æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†æ–‡ä»¶
    if full_tcl_path and full_tcl_path.exists():
        # ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆ full.tcl åï¼Œç«‹å³éªŒè¯ constraint
        try:
            validate_full_tcl_constraints(full_tcl_path, config_files, edp_center_path)
        except ValidationError as e:
            # ç”¨æˆ·è¾“å‡ºï¼ˆå‹å¥½æ ¼å¼ï¼Œä¿æŒåŸæœ‰è¡Œä¸ºï¼‰
            print(str(e), file=sys.stderr)
            
            # æ—¥å¿—è®°å½•ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰
            if log_exception:
                log_exception(logger, e)
            else:
                logger.error(f"é…ç½®éªŒè¯å¤±è´¥: {e.message}", exc_info=True)
            
            raise
        
        # ==================== é…ç½®å¿«ç…§ï¼šç”Ÿæˆåç«‹å³å¤‡ä»½ ====================
        # æ—¶æœºï¼šåœ¨ç”Ÿæˆæ–°çš„ full.tcl ä¹‹å
        # ç›®çš„ï¼šæ¯æ¬¡è¿è¡Œéƒ½æœ‰ç‹¬ç«‹çš„é…ç½®å¿«ç…§ï¼Œä¸ä¾èµ–ä¹‹å‰çš„è¿è¡Œ
        # 
        # æµç¨‹ï¼š
        # 1. ç”Ÿæˆæ–°çš„ full.tclï¼ˆç”¨äºæœ¬æ¬¡å®é™…æ‰§è¡Œï¼‰
        # 2. ç«‹å³å¤‡ä»½è¿™ä¸ªæ–°ç”Ÿæˆçš„ full.tclï¼ˆè¿™æ˜¯æœ¬æ¬¡è¿è¡Œçš„é…ç½®å¿«ç…§ï¼‰
        # 3. å¤‡ä»½æ–‡ä»¶çš„è·¯å¾„å°†è®°å½•åˆ° .run_info ä¸­
        #
        # è¿™æ ·æ¯æ¬¡è¿è¡Œéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå³ä½¿åç»­è¿è¡Œè¦†ç›–äº† full.tclï¼Œä¹Ÿèƒ½æ‰¾åˆ°æœ¬æ¬¡è¿è¡Œçš„é…ç½®
        backup_path = None
        try:
            # åˆ›å»ºå¤‡ä»½ç›®å½•
            backup_dir = full_tcl_path.parent / 'backups'
            backup_dir.mkdir(exist_ok=True)
            
            # ç”Ÿæˆå¤‡ä»½æ–‡ä»¶åï¼ˆå¸¦æ—¶é—´æˆ³ï¼Œæ ¼å¼ï¼šfull_YYYYMMDD_HHMMSS.tclï¼‰
            # æ—¶é—´æˆ³æ˜¯è¿è¡Œå¼€å§‹æ—¶é—´ï¼Œç”¨äºæ ‡è¯†æœ¬æ¬¡è¿è¡Œçš„é…ç½®å¿«ç…§
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            backup_name = f"full_{timestamp}.tcl"
            backup_path = backup_dir / backup_name
            
            # å¤‡ä»½åˆšç”Ÿæˆçš„ full.tclï¼ˆè¿™æ˜¯æœ¬æ¬¡è¿è¡Œçš„é…ç½®å¿«ç…§ï¼‰
            shutil.copy2(full_tcl_path, backup_path)
            logger.info(f"å·²åˆ›å»ºé…ç½®å¿«ç…§: {backup_path}ï¼ˆæœ¬æ¬¡è¿è¡Œçš„é…ç½®ï¼‰")
        except Exception as e:
            # å¦‚æœå¤‡ä»½å¤±è´¥ï¼Œè®°å½•è­¦å‘Šä½†ç»§ç»­æ‰§è¡Œ
            logger.warning(f"å¤‡ä»½ full.tcl å¤±è´¥: {e}ï¼Œå°†åªè®°å½• full.tcl è·¯å¾„")
            backup_path = None
        
        # è¿”å› (full.tcl è·¯å¾„, å¤‡ä»½æ–‡ä»¶è·¯å¾„)
        # å¤‡ä»½è·¯å¾„å°†è®°å½•åˆ° .run_info ä¸­ï¼Œç”¨äºåç»­çš„é…ç½®å¯¹æ¯”
        return (full_tcl_path, backup_path)
    else:
        # full.tcl æ–‡ä»¶æœªæˆåŠŸåˆ›å»ºï¼ŒæŠ›å‡ºå¼‚å¸¸
        raise EDPFileNotFoundError(
            f"full.tcl æ–‡ä»¶æœªæˆåŠŸåˆ›å»º: {full_tcl_path}",
            file_path=str(full_tcl_path),
            suggestion="è¯·æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™å’Œç£ç›˜ç©ºé—´"
        )
