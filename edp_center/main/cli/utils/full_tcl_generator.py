#!/usr/bin/env python
# -*- coding: utf-8 -*-

"""
full.tcl æ–‡ä»¶ç”Ÿæˆå™¨
è´Ÿè´£åˆå¹¶å¤šä¸ª YAML é…ç½®æ–‡ä»¶å¹¶ç”Ÿæˆ full.tcl æ–‡ä»¶
"""

import sys
import yaml
from pathlib import Path
from typing import Optional, Dict
from tkinter import Tcl
import logging

from edp_center.packages.edp_common import ValidationError, log_exception

# è·å– logger
logger = logging.getLogger(__name__)

from .tcl_generator import build_config_file_paths
from .tcl_generator.path_builder import build_output_path
from .tcl_generator.tcl_file_processor import process_tcl_file
from .tcl_generator.yaml_file_processor import process_yaml_file
from .tcl_generator.variable_writer import write_file_variables
from .tcl_generator.type_info_writer import write_type_info
from .tcl_generator.variable_protection import generate_variable_protection_code
from .tcl_generator.variable_validator import validate_file_variables_are_arrays, validate_all_variables_are_arrays
from .tcl_generator.auto_variables import write_auto_variables
from .tcl_generator.constraint_validator import validate_full_tcl_constraints


def generate_full_tcl(edp_center_path: Path, foundry: str, node: str, project: Optional[str],
                      work_path_info: Optional[Dict], flow_name: str, step_name: str, 
                      current_dir: Optional[Path] = None) -> Optional[Path]:
    """
    ç”Ÿæˆ full.tcl æ–‡ä»¶ï¼Œåˆå¹¶æ‰€æœ‰é…ç½® YAML æ–‡ä»¶
    
    Args:
        edp_center_path: edp_center è·¯å¾„
        foundry: ä»£å·¥å‚åç§°
        node: å·¥è‰ºèŠ‚ç‚¹
        project: é¡¹ç›®åç§°ï¼ˆå¯é€‰ï¼‰
        work_path_info: å·¥ä½œè·¯å¾„ä¿¡æ¯å­—å…¸ï¼ˆå¯é€‰ï¼‰
        flow_name: æµç¨‹åç§°
        step_name: æ­¥éª¤åç§°
        current_dir: å½“å‰ç›®å½•ï¼ˆå¯é€‰ï¼Œç”¨äºæŸ¥æ‰¾ user_config.yamlï¼‰
        
    Returns:
        full.tcl æ–‡ä»¶è·¯å¾„ï¼Œå¦‚æœç”Ÿæˆå¤±è´¥åˆ™è¿”å› None
    """
    try:
        # æ„å»ºæ‰€æœ‰ YAML æ–‡ä»¶è·¯å¾„ï¼ˆæŒ‰ä¼˜å…ˆçº§é¡ºåºï¼‰
        config_files = build_config_file_paths(
            edp_center_path, foundry, node, project, work_path_info, flow_name, current_dir
        )
        
        if not config_files:
            # æ²¡æœ‰æ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œè¿”å› None
            print(f"[WARN] æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆ full.tcl", file=sys.stderr)
            logger.warning("æœªæ‰¾åˆ°ä»»ä½•é…ç½®æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆ full.tcl")
            return None
        
        # æ„å»ºè¾“å‡ºæ–‡ä»¶è·¯å¾„
        full_tcl_path = build_output_path(work_path_info, flow_name, step_name, current_dir)
        
        # åˆ›å»ºä¸€ä¸ªå…±äº«çš„ Tcl interpreterï¼Œç”¨äºç´¯ç§¯æ‰€æœ‰å˜é‡
        shared_interp = Tcl()
        # åªåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–ç±»å‹ä¿¡æ¯æ•°ç»„
        shared_interp.eval("array set __configkit_types__ {}")
        
        # æ‰“å¼€è¾“å‡ºæ–‡ä»¶ï¼Œå‡†å¤‡å†™å…¥
        with open(full_tcl_path, 'w', encoding='utf-8') as f:
            # å†™å…¥æ–‡ä»¶å¤´
            f.write("# Generated by configkit\n")
            f.write("# Merged from the following files (in order, later files override earlier ones):\n")
            for config_file in config_files:
                abs_path = Path(config_file).resolve()
                f.write(f"#   - {abs_path}\n")
            f.write("\n")
            
            # é€ä¸ªè¯»å–å’Œè½¬æ¢é…ç½®æ–‡ä»¶ï¼ˆYAML æˆ– Tclï¼‰ï¼Œè½¬æ¢åç«‹å³è¾“å‡º
            for config_file in config_files:
                try:
                    config_file_path = Path(config_file)
                    abs_path = config_file_path.resolve()
                    
                    # æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©è§£ææ–¹å¼
                    if config_file_path.suffix.lower() == '.tcl':
                        # å¤„ç† Tcl æ–‡ä»¶
                        temp_interp = process_tcl_file(config_file_path, shared_interp)
                    else:
                        # å¤„ç† YAML æ–‡ä»¶ï¼ˆé»˜è®¤ï¼‰
                        temp_interp = process_yaml_file(config_file_path, shared_interp)
                        if temp_interp is None:
                            # æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡
                            continue
                    
                    # éªŒè¯è¯¥æ–‡ä»¶å®šä¹‰çš„å˜é‡éƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼ˆå¸¦å‘½åç©ºé—´ï¼‰
                    try:
                        validate_file_variables_are_arrays(temp_interp, abs_path)
                    except ValueError as e:
                        # å‘ç°ç®€å•å˜é‡ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶æŠ›å‡ºå¼‚å¸¸
                        print(f"[ERROR] å˜é‡æ ¼å¼éªŒè¯å¤±è´¥:", file=sys.stderr)
                        print(str(e), file=sys.stderr)
                        logger.error(f"å˜é‡æ ¼å¼éªŒè¯å¤±è´¥: {e}", extra={'config_file': str(abs_path)})
                        raise
                    
                    # ç«‹å³è¾“å‡ºè¯¥æ–‡ä»¶å®šä¹‰çš„å˜é‡
                    write_file_variables(shared_interp, temp_interp, abs_path, f)
                    
                except yaml.YAMLError:
                    # YAML è§£æé”™è¯¯å·²ç»åœ¨ process_yaml_file ä¸­å¤„ç†äº†ï¼Œè¿™é‡Œé‡æ–°æŠ›å‡º
                    raise
                except Exception as e:
                    # å…¶ä»–é”™è¯¯ï¼ˆå¦‚æ–‡ä»¶è¯»å–å¤±è´¥ï¼‰ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯ä½†ç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶
                    abs_path = Path(config_file).resolve()
                    print(f"[WARN] å¤„ç†é…ç½®æ–‡ä»¶å¤±è´¥: {abs_path}", file=sys.stderr)
                    print(f"[WARN] é”™è¯¯ä¿¡æ¯: {e}", file=sys.stderr)
                    print(f"[WARN] è·³è¿‡è¯¥æ–‡ä»¶ï¼Œç»§ç»­å¤„ç†å…¶ä»–æ–‡ä»¶", file=sys.stderr)
                    logger.warning(f"å¤„ç†é…ç½®æ–‡ä»¶å¤±è´¥: {abs_path}", exc_info=True, extra={'config_file': str(abs_path), 'error': str(e)})
                    continue
            
            # éªŒè¯æ‰€æœ‰å˜é‡éƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼ˆå¸¦å‘½åç©ºé—´ï¼‰
            try:
                validate_all_variables_are_arrays(shared_interp)
            except ValueError as e:
                # å‘ç°ç®€å•å˜é‡ï¼Œè¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶æŠ›å‡ºå¼‚å¸¸
                print(f"[ERROR] å˜é‡æ ¼å¼éªŒè¯å¤±è´¥:", file=sys.stderr)
                print(str(e), file=sys.stderr)
                logger.error(f"å˜é‡æ ¼å¼éªŒè¯å¤±è´¥: {e}", exc_info=True)
                raise
            
            # é‡æ–°å†™å…¥è‡ªåŠ¨ç”Ÿæˆçš„å˜é‡ï¼ˆç¡®ä¿å®ƒä»¬ä¸è¢«é…ç½®æ–‡ä»¶è¦†ç›–ï¼‰
            # è¿™äº›å˜é‡åº”è¯¥åœ¨æœ€åï¼Œç¡®ä¿å®ƒä»¬çš„å€¼ä¸ä¼šè¢«é…ç½®æ–‡ä»¶è¦†ç›–
            f.write("\n")  # åœ¨è‡ªåŠ¨ç”Ÿæˆçš„å˜é‡ä¹‹å‰æ·»åŠ ç©ºè¡Œï¼Œä¸é…ç½®æ–‡ä»¶å˜é‡åˆ†éš”
            write_auto_variables(
                work_path_info, foundry, node, project,
                flow_name, step_name, full_tcl_path, edp_center_path, f
            )
            
            # ç”Ÿæˆå˜é‡ä¿æŠ¤ä»£ç ï¼ˆå¦‚æœå­˜åœ¨æ–°æ ¼å¼å˜é‡ï¼‰
            generate_variable_protection_code(shared_interp, f)
            
            # å¯¼å‡ºç±»å‹ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            write_type_info(shared_interp, f)
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ›å»ºäº†æ–‡ä»¶
        if full_tcl_path and full_tcl_path.exists():
            # ğŸ”¥ æ–°å¢ï¼šç”Ÿæˆ full.tcl åï¼Œç«‹å³éªŒè¯ constraint
            try:
                validate_full_tcl_constraints(full_tcl_path, config_files, edp_center_path)
            except ValidationError as e:
                # ç”¨æˆ·è¾“å‡ºï¼ˆå‹å¥½æ ¼å¼ï¼Œä¿æŒåŸæœ‰è¡Œä¸ºï¼‰
                print(str(e), file=sys.stderr)
                
                # æ—¥å¿—è®°å½•ï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰
                if log_exception:
                    log_exception(logger, e)
                else:
                    logger.error(f"é…ç½®éªŒè¯å¤±è´¥: {e.message}", exc_info=True)
                
                raise
            
            return full_tcl_path
        else:
            print(f"[WARN] full.tcl æ–‡ä»¶æœªæˆåŠŸåˆ›å»º: {full_tcl_path}", file=sys.stderr)
            logger.warning(f"full.tcl æ–‡ä»¶æœªæˆåŠŸåˆ›å»º: {full_tcl_path}")
            return None
        
    except ValueError as e:
        # å˜é‡æ ¼å¼éªŒè¯å¤±è´¥ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸æ•è·
        # è¿™æ ·è°ƒç”¨è€…å¯ä»¥çŸ¥é“æ˜¯éªŒè¯å¤±è´¥ï¼Œè€Œä¸æ˜¯å…¶ä»–é”™è¯¯
        logger.error(f"å˜é‡æ ¼å¼éªŒè¯å¤±è´¥: {e}", exc_info=True)
        raise
    except (OSError, IOError, yaml.YAMLError) as e:
        # æ–‡ä»¶æ“ä½œé”™è¯¯æˆ– YAML è§£æé”™è¯¯
        print(f"[ERROR] ç”Ÿæˆ full.tcl å¤±è´¥: {e}", file=sys.stderr)
        logger.error(f"ç”Ÿæˆ full.tcl å¤±è´¥: {e}", exc_info=True)
        return None
    except Exception as e:
        # å…¶ä»–æœªé¢„æœŸçš„é”™è¯¯
        print(f"[ERROR] ç”Ÿæˆ full.tcl æ—¶å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯: {e}", file=sys.stderr)
        logger.exception("ç”Ÿæˆ full.tcl æ—¶å‘ç”Ÿæœªé¢„æœŸçš„é”™è¯¯")
        return None
