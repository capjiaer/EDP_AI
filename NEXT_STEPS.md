# 下一步工作计划

## 📊 当前状态总结

### ✅ 已完成的工作

1. **代码重构** ✅
   - `arg_parser.py` (800行 → 模块化)
   - `generator.py` (703行 → 34行)
   - `workflow_web/handlers.py` (444行 → 18行)
   - `rollback_handler.py` (560行 → 273行)

2. **统一错误处理** ✅
   - 统一的异常体系
   - 统一的错误处理装饰器
   - 改进的错误消息

3. **测试框架** ✅
   - 23个测试全部通过
   - 覆盖文件搜索缓存、历史查询、性能统计、参数解析

4. **功能实现** ✅
   - `history` 命令 - 历史查询
   - `stats` 命令 - 性能统计
   - `rollback` 命令 - 配置对比和回滚
   - 文件搜索缓存机制

5. **公共逻辑提取** ✅
   - `command_helpers.py` - 统一的项目/路径推断逻辑

---

## 🎯 下一步建议（按优先级排序）

### 🔴 高优先级

#### 1. 提高测试覆盖率 ⏳
**当前**: ~30%  
**目标**: 80%+

**任务**:
- [ ] 添加端到端测试（完整的命令执行流程）
- [ ] 添加错误场景测试（各种错误情况的处理）
- [ ] 添加边界情况测试（边界值和特殊情况）
- [ ] 测试更多 CLI 命令（-run, -info, -validate 等）

**工作量**: 中等（3-5天）  
**影响**: 提高代码质量，减少回归

---

#### 2. 完善现有功能 ⏳
**待完成的小功能**:

- [ ] **stats 导出功能** (`stats_handler.py:305`)
  - 支持导出统计信息到 CSV/JSON
  - 支持导出性能趋势图表

- [ ] **rollback 时间点查找** (`rollback_history.py:104`)
  - 支持按时间点查找历史记录
  - 支持时间范围查询

**工作量**: 小（1-2天）  
**影响**: 提升用户体验

---

### 🟡 中优先级

#### 3. 性能优化 ⏳
**潜在优化点**:

- [ ] 配置合并优化（增量更新）
- [ ] 文件搜索进一步优化（多路径并行搜索）
- [ ] 大型项目的启动时间优化

**工作量**: 中等（2-3天）  
**影响**: 提升用户体验，特别是大型项目

---

#### 4. 代码质量改进 ⏳
**待改进项**:

- [ ] 完善文档字符串（部分文件缺少完整文档）
- [ ] 统一代码风格（部分函数参数过多，考虑使用配置对象）
- [ ] 清理废弃代码（如有）

**工作量**: 小到中等（1-3天）  
**影响**: 提高可维护性

---

### 🟢 低优先级

#### 5. 功能增强 ⏳
**长期规划**:

- [ ] RELEASE 恢复功能（暂缓，等待实际需求）
- [ ] 步骤级别的重试机制
- [ ] 更细粒度的状态管理
- [ ] 异步执行机制

**工作量**: 大（5-10天）  
**影响**: 提升用户体验和性能

---

#### 6. 文档完善 ⏳
**待完善文档**:

- [ ] 完善 API 文档
- [ ] 添加架构设计文档
- [ ] 添加贡献指南
- [ ] 添加更多使用示例

**工作量**: 中等（2-3天）  
**影响**: 提高可维护性，便于新开发者加入

---

## 📋 推荐的工作顺序

### 第一阶段（本周）
1. ✅ 完善现有功能（stats 导出、rollback 时间点查找）
2. ✅ 添加端到端测试

### 第二阶段（下周）
3. ✅ 添加错误场景测试
4. ✅ 提高测试覆盖率到 50%+

### 第三阶段（后续）
5. ✅ 性能优化
6. ✅ 代码质量改进
7. ✅ 文档完善

---

## 💡 具体建议

### 立即开始：完善现有功能

**任务 1: stats 导出功能**
```python
# 在 stats_handler.py 中添加
def export_stats(stats: Dict, format: str = 'csv', output_path: Optional[Path] = None):
    """
    导出统计信息
    
    Args:
        stats: 统计数据字典
        format: 导出格式（csv/json）
        output_path: 输出路径
    """
    # TODO: 实现导出功能
```

**任务 2: rollback 时间点查找**
```python
# 在 rollback_history.py 中添加
def find_runs_by_time_range(runs: List[Dict], from_time: str, to_time: str) -> List[Dict]:
    """
    按时间范围查找运行记录
    
    Args:
        runs: 运行历史记录列表
        from_time: 起始时间（格式: YYYY-MM-DD HH:MM:SS）
        to_time: 结束时间（格式: YYYY-MM-DD HH:MM:SS）
    """
    # TODO: 实现时间点查找
```

---

## ✅ 总结

**当前状态**: 核心功能已完成，代码质量良好，测试框架已建立

**下一步重点**: 
1. 提高测试覆盖率（最重要）
2. 完善现有功能的小细节
3. 性能优化

**建议**: 先完成测试覆盖率的提升，这样可以确保后续改进不会引入回归问题。

